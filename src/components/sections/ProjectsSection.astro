---
import Image from "astro/components/Image.astro";
import { completedProjects as completedData, ongoingProjects as ongoingData } from "../../data/projects";
import { ArrowRightIcon } from "../icons";

const baseUrl = (import.meta.env.BASE_URL || '/').replace(/\/?$/, '/');
const projectsPageUrl = `${baseUrl}projeler`;
const completedProjects = completedData.map((p) => ({ ...p, image: `${baseUrl}${p.image}` }));
const ongoingProjects = ongoingData.map((p) => ({ ...p, image: `${baseUrl}${p.image}` }));
---

<section id="projeler" class="w-full bg-white pb-12 md:py-20 px-4 md:px-6">
  <div class="max-w-[1480px] mx-auto">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 md:mb-10 gap-4 md:gap-0">
      <div>
        <p class="inline-block text-[#E30A17] text-sm sm:text-base md:text-lg font-bold mb-2 md:mb-4 tracking-wider uppercase bg-[#E30A17]/15 px-4 py-2 sm:px-5 sm:py-2.5 rounded-xl">
          342+ TAMAMLANAN PROJE
        </p>
        <h2 class="text-[#262322] text-3xl md:text-4xl lg:text-5xl font-semibold leading-tight">
          Projeler
        </h2>
      </div>
      
      <a
      href={projectsPageUrl}
      class="ml-auto inline-flex justify-end items-center gap-2 sm:gap-3 rounded-full bg-[#E30A17] pl-1.5 sm:pl-2 pr-4 sm:pr-6 py-1.5 sm:py-2 text-sm sm:text-base font-medium text-white hover:bg-[#e30a18df] transition-all duration-300 shadow-lg hover:shadow-xl"
    >
      <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-white flex items-center justify-center shrink-0">
        <ArrowRightIcon color="#E30A17"/>
      </div>
      Daha Fazla
    </a>
    </div>

    <!-- Sekmeler -->
    <div class="flex flex-wrap items-center gap-4 mb-8 md:mb-12 border-b border-gray-200">
      <button 
        class="project-tab px-4 py-2 md:px-6 md:py-3 text-sm md:text-base font-semibold border-b-2 border-transparent transition-colors active-tab"
        data-tab="completed"
        id="tab-completed"
      >
        Tamamlanan Projelerimiz
      </button>
      <button 
        class="project-tab px-4 py-2 md:px-6 md:py-3 text-sm md:text-base font-semibold border-b-2 border-transparent transition-colors"
        data-tab="ongoing"
        id="tab-ongoing"
      >
        Devam Eden Projelerimiz
      </button>
      <div class="hidden md:flex items-center gap-3 ml-auto">
        <button 
          class="projects-carousel-btn projects-carousel-btn-prev w-12 h-12 rounded-full bg-[#E30A17] flex items-center justify-center hover:bg-[#c00914] transition-colors z-10"
          id="projects-prev-btn"
          aria-label="Önceki"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <button 
          class="projects-carousel-btn projects-carousel-btn-next w-12 h-12 rounded-full bg-[#E30A17] flex items-center justify-center hover:bg-[#c00914] transition-colors z-10"
          id="projects-next-btn"
          aria-label="Sonraki"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="relative">
      <!-- Tamamlanan Projeler -->
      <div class="projects-carousel-container overflow-hidden" id="carousel-completed">
        <div class="projects-carousel-track flex transition-transform duration-500 ease-in-out" id="projects-carousel-track-completed">
          {completedProjects.map((project, index) => (
            <div class="projects-carousel-slide min-w-[85%] sm:min-w-[70%] md:min-w-[25%] px-2 md:px-3" data-index={index}>
              <div class="relative w-full overflow-hidden rounded-2xl bg-white shadow-lg group cursor-pointer">
                <div class="aspect-[3/4] md:aspect-[2/3] relative overflow-hidden">
                  <Image 
                    src={project.image}
                    alt={project.name}
                    width={600}
                    height={450}
                    class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                  />
                  <div class="absolute top-2 right-2 md:top-4 md:right-4 bg-white px-2 py-1 md:px-4 md:py-2 rounded-lg shadow-md">
                    <p class="text-[#262322] text-xs md:text-sm lg:text-base font-semibold">
                      {project.name}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Devam Eden Projeler -->
      <div class="projects-carousel-container overflow-hidden hidden" id="carousel-ongoing">
        <div class="projects-carousel-track flex transition-transform duration-500 ease-in-out" id="projects-carousel-track-ongoing">
          {ongoingProjects.map((project, index) => (
            <div class="projects-carousel-slide min-w-[85%] sm:min-w-[70%] md:min-w-[25%] px-2 md:px-3" data-index={index}>
              <div class="relative w-full overflow-hidden rounded-2xl bg-white shadow-lg group cursor-pointer">
                <div class="aspect-[3/4] md:aspect-[2/3] relative overflow-hidden">
                  <Image 
                    src={project.image}
                    alt={project.name}
                    width={600}
                    height={450}
                    class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                  />
                  <div class="absolute top-2 right-2 md:top-4 md:right-4 bg-white px-2 py-1 md:px-4 md:py-2 rounded-lg shadow-md">
                    <p class="text-[#262322] text-xs md:text-sm lg:text-base font-semibold">
                      {project.name}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
      
      <!-- Mobil butonlar -->
      <div class="flex md:hidden items-center justify-center gap-4 mt-6">
        <button 
          class="projects-carousel-btn projects-carousel-btn-prev w-12 h-12 rounded-full bg-[#E30A17] flex items-center justify-center hover:bg-[#c00914] active:bg-[#a00811] transition-colors z-10"
          id="projects-prev-btn-mobile"
          aria-label="Önceki"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <button 
          class="projects-carousel-btn projects-carousel-btn-next w-12 h-12 rounded-full bg-[#E30A17] flex items-center justify-center hover:bg-[#c00914] active:bg-[#a00811] transition-colors z-10"
          id="projects-next-btn-mobile"
          aria-label="Sonraki"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</section>

<script>
  let currentTab = 'completed';
  let carouselInstances: { [key: string]: any } = {};

  function initCarousel(tabType: string) {
    const trackId = `projects-carousel-track-${tabType}`;
    const track = document.getElementById(trackId);
    if (!track) return null;

    const slides = track.querySelectorAll('.projects-carousel-slide');
    let currentIndex = 0;
    let isMobile = window.innerWidth < 640;
    let isTablet = window.innerWidth >= 640 && window.innerWidth < 768;
    let slidesToShow = isMobile ? 1 : 4;
    let autoPlayInterval: number | null = null;

    function updateCarousel() {
      if (!track) return;
      
      let translateX;
      if (isMobile) {
        translateX = -currentIndex * 85;
      } else if (isTablet) {
        translateX = -currentIndex * 70;
      } else {
        translateX = -currentIndex * (100 / slidesToShow);
      }
      
      track.style.transform = `translateX(${translateX}%)`;
    }

    function goToNext() {
      if (isMobile) {
        currentIndex = (currentIndex + 1) % slides.length;
      } else {
        if (currentIndex >= slides.length - slidesToShow) {
          currentIndex = 0;
        } else {
          currentIndex = currentIndex + 1;
        }
      }
      updateCarousel();
      stopAutoPlay();
      startAutoPlay();
    }

    function goToPrev() {
      if (isMobile) {
        currentIndex = (currentIndex - 1 + slides.length) % slides.length;
      } else {
        currentIndex = Math.max(currentIndex - 1, 0);
      }
      updateCarousel();
      stopAutoPlay();
      startAutoPlay();
    }
    
    function startAutoPlay() {
      autoPlayInterval = setInterval(goToNext, 4000) as unknown as number;
    }

    function stopAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
      }
    }

    const carouselContainer = document.getElementById(`carousel-${tabType}`);
    if (carouselContainer) {
      carouselContainer.addEventListener('mouseenter', stopAutoPlay);
      carouselContainer.addEventListener('mouseleave', startAutoPlay);
    }

    function handleResize() {
      const wasMobile = isMobile;
      const wasTablet = isTablet;
      isMobile = window.innerWidth < 640;
      isTablet = window.innerWidth >= 640 && window.innerWidth < 768;
      slidesToShow = isMobile ? 1 : 4;
      if (wasMobile !== isMobile || wasTablet !== isTablet) {
        currentIndex = 0;
        updateCarousel();
      }
    }

    updateCarousel();
    startAutoPlay();

    return {
      goToNext,
      goToPrev,
      stopAutoPlay,
      handleResize
    };
  }

  function initProjectsCarousel() {
    // Sekme değiştirme
    const tabs = document.querySelectorAll('.project-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabType = tab.getAttribute('data-tab');
        if (!tabType) return;

        // Sekme stillerini güncelle
        tabs.forEach(t => {
          t.classList.remove('active-tab', 'border-[#E30A17]', 'text-[#E30A17]');
          t.classList.add('border-transparent', 'text-[#262322]');
        });
        tab.classList.add('active-tab', 'border-[#E30A17]', 'text-[#E30A17]');
        tab.classList.remove('border-transparent', 'text-[#262322]');

        // Carousel'ları göster/gizle
        const completedCarousel = document.getElementById('carousel-completed');
        const ongoingCarousel = document.getElementById('carousel-ongoing');
        
        if (tabType === 'completed') {
          if (completedCarousel) completedCarousel.classList.remove('hidden');
          if (ongoingCarousel) ongoingCarousel.classList.add('hidden');
          currentTab = 'completed';
        } else {
          if (completedCarousel) completedCarousel.classList.add('hidden');
          if (ongoingCarousel) ongoingCarousel.classList.remove('hidden');
          currentTab = 'ongoing';
        }

        // Aktif carousel'ı yeniden başlat
        Object.keys(carouselInstances).forEach(key => {
          if (carouselInstances[key] && carouselInstances[key].stopAutoPlay) {
            carouselInstances[key].stopAutoPlay();
          }
        });
        
        if (carouselInstances[currentTab]) {
          carouselInstances[currentTab].stopAutoPlay();
        }
        carouselInstances[currentTab] = initCarousel(currentTab);
      });
    });

    // Her iki carousel'ı başlat
    carouselInstances.completed = initCarousel('completed');
    carouselInstances.ongoing = initCarousel('ongoing');

    // Buton event listener'ları - aktif carousel'ı kontrol eder
    const prevBtn = document.getElementById('projects-prev-btn');
    const nextBtn = document.getElementById('projects-next-btn');
    const prevBtnMobile = document.getElementById('projects-prev-btn-mobile');
    const nextBtnMobile = document.getElementById('projects-next-btn-mobile');

    function handlePrev() {
      const currentCarousel = carouselInstances[currentTab];
      if (currentCarousel) currentCarousel.goToPrev();
    }

    function handleNext() {
      const currentCarousel = carouselInstances[currentTab];
      if (currentCarousel) currentCarousel.goToNext();
    }

    if (prevBtn) prevBtn.addEventListener('click', handlePrev);
    if (nextBtn) nextBtn.addEventListener('click', handleNext);
    if (prevBtnMobile) prevBtnMobile.addEventListener('click', handlePrev);
    if (nextBtnMobile) nextBtnMobile.addEventListener('click', handleNext);

    // Resize handler
    let resizeTimeout: number;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        Object.keys(carouselInstances).forEach(key => {
          if (carouselInstances[key] && carouselInstances[key].handleResize) {
            carouselInstances[key].handleResize();
        }
        });
      }, 250) as unknown as number;
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProjectsCarousel);
  } else {
    initProjectsCarousel();
  }
</script>

<style>
  .projects-carousel-container {
    position: relative;
  }

  .projects-carousel-track {
    display: flex;
    will-change: transform;
  }

  .projects-carousel-slide {
    flex-shrink: 0;
  }

  .project-tab {
    color: #262322;
    cursor: pointer;
  }

  .project-tab:hover {
    color: #E30A17;
  }

  .project-tab.active-tab {
    color: #E30A17;
    border-bottom-color: #E30A17;
  }
</style>

